# -*- mode: Snakemake -*-
# Processing Rules

rule post_align_process:
  input:
    bam=RUN_DIR + "/processData/{sample}.bam",
    bai=RUN_DIR + "/processData/{sample}.bai",
    key=RUN_DIR + "/processData/{sample}.key.csv"
  output:
    uniq=RUN_DIR + "/output/unique_aligns/{sample}.uniq.csv",
    chim=RUN_DIR + "/output/chimera_aligns/{sample}.chim.csv"
  params: 
    ROOT_DIR + "/tools/rtools/post_algn_process.R"
  log: 
    RUN_DIR + "/logs/{sample}.postalgn.log"
  shell:
    """
    Rscript {params} {input.bam} -i {input.bai} -k {input.key} \
      -o {output.uniq} -c {output.chim} > {log} 2>&1
    """

rule collate_unique:
  input:
    expand(RUN_DIR + "/output/unique_aligns/{sample}.uniq.csv", sample=SAMPLES)
  output:
    RUN_DIR + "/output/unique_aligns." + RUN + ".csv"
  params:
    RUN_DIR + "/output"
  shell:
    """
    head -n 1 -q {params}/unique_aligns/* | uniq > {output}
    cat {params}/unique_aligns/* | sed '/qname/d' >> {output}
    """

rule collate_chimera:
  input:
    expand(RUN_DIR + "/output/chimera_aligns/{sample}.chim.csv", sample=SAMPLES)
  output:
    RUN_DIR + "/output/chimera_aligns." + RUN + ".csv"
  params:
    RUN_DIR + "/output"
  shell:
    """
    head -n 1 -q {params}/chimera_aligns/* | uniq > {output}
    cat {params}/chimera_aligns/* | sed '/qname/d' >> {output}
    """
